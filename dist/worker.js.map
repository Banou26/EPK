{"version":3,"file":"worker.js","sources":["../src/core/task.ts","../src/worker/analyzer.ts","../src/worker/pre-analyzer.ts","../src/worker/runner.ts","../src/worker/index.ts"],"sourcesContent":["import { Observable } from 'rxjs'\r\n\r\nexport enum TASK_TYPE {\r\n  PRE_ANALYZE = 'preAnalyze',\r\n  RUN = 'run',\r\n  ANALYZE = 'analyze'\r\n}\r\n\r\nexport enum TASK_STATUS {\r\n  START = 'start',\r\n  READY = 'ready',\r\n  END = 'end',\r\n  CANCEL = 'cancel'\r\n}\r\n\r\nexport interface Task {\r\n  type: TASK_TYPE\r\n  data: any\r\n}\r\n\r\nexport interface TaskMessage {\r\n  type: TASK_TYPE\r\n  status: TASK_STATUS\r\n  data?: any\r\n}\r\n\r\n// export default\r\n//   (task: Task) =>\r\n//     messages =>\r\n//       messages\r\n//       |> \r\n\r\n\r\n// export default (task: Task) =>\r\n//   Observable.create(observer => {\r\n//     let _observer\r\n//     const task = Observable.create<TaskMessage>(observer => {\r\n//       _observer = observer\r\n//       observer.next({ type: TASK_STATUS.START })\r\n//       return () => observer.next({ type: TASK_STATUS.CANCEL })\r\n//     })\r\n//     workerFarm.next(task)\r\n//     return () => _observer.complete()\r\n//   })\r\n","import { tap, first, switchMap } from 'rxjs/operators'\r\nimport { Observable } from 'rxjs'\r\n\r\nexport default task => {\r\n  return (\r\n    task\r\n    |> first()\r\n    |> switchMap(v =>\r\n      Observable.create(observer => {\r\n        return () => {}\r\n      })\r\n    )\r\n  )\r\n}\r\n","import { tap } from 'rxjs/operators';\r\n\r\nexport default task => {\r\n  return (\r\n    task\r\n    |> tap(v => console.log(v))\r\n  )\r\n}\r\n","import { tap } from 'rxjs/operators';\r\n\r\nexport default task => {\r\n  return (\r\n    task\r\n    |> tap(v => console.log(v))\r\n  )\r\n}\r\n","import { parentPort } from 'worker_threads'\r\n\r\nimport { TASK_STATUS, TASK_TYPE } from '../core/task.ts'\r\nimport { fromEvent, of, Subject } from 'rxjs'\r\nimport { tap, shareReplay, first, filter, switchMap, groupBy, mergeMap, finalize } from 'rxjs/operators'\r\n\r\nimport analyze from './analyzer.ts'\r\nimport preAnalyze from './pre-analyzer.ts'\r\nimport run from './runner.ts'\r\n\r\nconst taskMap = new Map([\r\n  [TASK_TYPE.ANALYZE, analyze],\r\n  [TASK_TYPE.PRE_ANALYZE, preAnalyze],\r\n  [TASK_TYPE.RUN, run]\r\n])\r\n\r\nconst runTask = messages => {\r\n  const replay = messages |> shareReplay()\r\n\r\n  return (\r\n    replay\r\n    |> first()\r\n    |> switchMap(({ id, type }) =>\r\n      taskMap.get(type)(replay)\r\n      |> finalize(() => parentPort.postMessage({ id, status: TASK_STATUS.END }))\r\n    )\r\n    |> tap(message => parentPort.postMessage(message))\r\n  )\r\n}\r\n\r\nexport default runTask\r\n\r\nif (parentPort) {\r\n  const tasks =\r\n    fromEvent(parentPort, 'message')\r\n    |> groupBy(({ id }) => id)\r\n    |> mergeMap(runTask)\r\n\r\n  tasks.subscribe()\r\n}\r\n"],"names":["TASK_TYPE","TASK_STATUS","task","first","switchMap","v","Observable","create","observer","tap","console","log","taskMap","Map","ANALYZE","analyze","PRE_ANALYZE","preAnalyze","RUN","run","runTask","messages","replay","shareReplay","id","type","get","finalize","parentPort","postMessage","status","END","message","tasks","fromEvent","groupBy","mergeMap","subscribe"],"mappings":";;;;;;IAEYA,SAAZ;;WAAYA;EAAAA;EAAAA;EAAAA;GAAAA,cAAAA;;AAMZ,IAAYC,WAAZ;;WAAYA;EAAAA;EAAAA;EAAAA;EAAAA;GAAAA,gBAAAA;;;;;;;;;;;;;;;;;ACLZ,eAAeC,IAAI,IAAI;;;yBAEnBA,IADF,EAEKC,eAAK,EAFV,UAGKC,mBAAS,CAACC,CAAC,IACZC,eAAU,CAACC,MAAX,CAAkBC,QAAQ,IAAI;WACrB,MAAM,EAAb;GADF,CADU,CAHd;CADF;;ACDA,kBAAeN,IAAI,IAAI;;;iBAEnBA,IADF,EAEKO,aAAG,CAACJ,CAAC,IAAIK,OAAO,CAACC,GAAR,CAAYN,CAAZ,CAAN,CAFR;CADF;;ACAA,WAAeH,IAAI,IAAI;;;iBAEnBA,IADF,EAEKO,aAAG,CAACJ,CAAC,IAAIK,OAAO,CAACC,GAAR,CAAYN,CAAZ,CAAN,CAFR;CADF;;ACQA,MAAMO,OAAO,GAAG,IAAIC,GAAJ,CAAQ,CACtB,CAACb,SAAS,CAACc,OAAX,EAAoBC,OAApB,CADsB,EAEtB,CAACf,SAAS,CAACgB,WAAX,EAAwBC,UAAxB,CAFsB,EAGtB,CAACjB,SAAS,CAACkB,GAAX,EAAgBC,GAAhB,CAHsB,CAAR,CAAhB;;AAMA,MAAMC,OAAO,GAAGC,QAAQ,IAAI;;;QACpBC,MAAM,gBAAGD,QAAH,EAAeE,qBAAW,EAA1B,YAAZ;oCAGED,MADF,EAEKnB,eAAK,EAFV,YAGKC,mBAAS,CAAC,CAAC;IAAEoB,EAAF;IAAMC;GAAP;;;0BACXb,OAAO,CAACc,GAAR,CAAYD,IAAZ,EAAkBH,MAAlB,CADW,EAERK,kBAAQ,CAAC,MAAMC,yBAAU,CAACC,WAAX,CAAuB;MAAEL,EAAF;MAAMM,MAAM,EAAE7B,WAAW,CAAC8B;KAAjD,CAAP,CAFA;GAAD,CAHd,UAOKtB,aAAG,CAACuB,OAAO,IAAIJ,yBAAU,CAACC,WAAX,CAAuBG,OAAvB,CAAZ,CAPR;CAHF;;AAgBA,IAAIJ,yBAAJ,EAAgB;;;QACRK,KAAK,0BACTC,cAAS,CAACN,yBAAD,EAAa,SAAb,CADA,EAENO,iBAAO,CAAC,CAAC;IAAEX;GAAH,KAAYA,EAAb,CAFD,eAGNY,kBAAQ,CAAChB,OAAD,CAHF,QAAX;EAKAa,KAAK,CAACI,SAAN;;;;;"}