{"version":3,"file":"browser.js","sources":["../src/runtime/assert.ts","../src/types.ts","../src/utils/flatted.ts","../src/runtime/utils.ts","../src/runtime/test.ts"],"sourcesContent":["import PowerAssert from 'power-assert'\r\n\r\nexport default PowerAssert.customize({\r\n\r\n})\r\n","\r\nimport { Observable, Subject } from 'rxjs'\r\nimport { ParcelBundle } from 'parcel-bundler'\r\nimport { CoverageEntry, ElementHandle } from 'puppeteer'\r\n\r\n// Subject that is sent data from the tester to the runtime\r\nexport const EPK_SUBJECT = '__EPK__SUBJECT__'\r\n// Subject that is sent data from the runtime to the tester\r\nexport const EPK_RUNTIME_SUBJECT = '__EPK__RUNTIME__SUBJECT__'\r\nexport const EPK_FUNCTION_PROPERTY_PLACEHOLDER = '__EPK__FUNCTION__PLACEHOLDER__'\r\n\r\nexport interface Bundler extends Observable<any> {}\r\n\r\n// Going to change when Parcel 2 get released\r\nexport interface Options {\r\n  outDir: string\r\n  entryFiles: string | string[]\r\n  target: TARGET\r\n  watch?: boolean\r\n  browsers?: BROWSER[]\r\n  port?: number\r\n}\r\n\r\nexport interface installImportOptions {\r\n  path: string\r\n  dev: boolean\r\n}\r\n\r\nexport interface TestBundle {\r\n  /**\r\n   * Parcel bundle\r\n   */\r\n  parcelBundle: ParcelBundle\r\n  /**\r\n   * Entry files\r\n   */\r\n  entryFiles: string[]\r\n  /**\r\n   * Time at which the bundling started(high precision timestamp)\r\n   */\r\n  buildStartTime: number\r\n  /**\r\n   * Time at which the bundling ended(high precision timestamp)\r\n   */\r\n  buildEndTime: number\r\n}\r\n\r\n/**\r\n * Representation of a file\r\n */\r\nexport interface TestFile {\r\n  /**\r\n   * Bundle\r\n   */\r\n  bundle: TestBundle\r\n  /**\r\n   * Hashes of all the parcel assets\r\n   */\r\n  hashes: Set<string>\r\n  /**\r\n   * Path of the source test file\r\n   */\r\n  name: string\r\n  /**\r\n   * Prettified path of the source test file\r\n   */\r\n  displayName: string\r\n  /**\r\n   * Path of the bundled test file\r\n   */\r\n  path: string\r\n  /**\r\n   * Target\r\n   */\r\n  target: TARGET | RUNTIME\r\n  /**\r\n   * Url by which browsers can access the test file\r\n   * Not defined if target is node\r\n   */\r\n  url?: string\r\n  /**\r\n   * Array of analyzed tests\r\n   */\r\n  tests?: Test[] | undefined\r\n  /**\r\n   * Array of logs logged without running the tests\r\n   */\r\n  logs?: Log[]\r\n  /**\r\n   * Time at which the test preprocessing started(high precision timestamp)\r\n   */\r\n  preprocessingStart?: number\r\n  /**\r\n   * Time at which the test preprocessing ended(high precision timestamp)\r\n   */\r\n  preprocessingEnd?: number\r\n}\r\n\r\nexport interface TestFileRuntimeAggregation {\r\n/**\r\n   * Bundle\r\n   */\r\n  bundle: TestBundle\r\n  /**\r\n   * Hashes of all the parcel assets\r\n   */\r\n  hashes: Set<string>\r\n  /**\r\n   * Path of the source test file\r\n   */\r\n  name: string\r\n  /**\r\n   * Prettified path of the source test file\r\n   */\r\n  displayName: string\r\n  /**\r\n   * Path of the bundled test file\r\n   */\r\n  path: string\r\n  /**\r\n   * Array of analyzed tests\r\n   */\r\n  tests?: Test[] | undefined\r\n  /**\r\n   * Url by which browsers can access the test file\r\n   * Not defined if target is node\r\n   */\r\n  url?: string\r\n  /**\r\n   * Map of tested file per runtime\r\n   */\r\n  testFiles: Map<RUNTIME, TestFile>\r\n}\r\n\r\n/**\r\n * Representation of a test\r\n */\r\nexport interface Test {\r\n  /**\r\n   * Description of the test\r\n   */\r\n  description: string\r\n  /**\r\n   * Body of the test (Stringified function)\r\n   */\r\n  body: string\r\n  /**\r\n   * String type of test: Function | Promise<any> | Observable<any>\r\n   */\r\n\r\n  //** Properties from the test when executed\r\n  \r\n  type?: string\r\n  /**\r\n   * Flatted(https://github.com/WebReflection/flatted) value returned by the test\r\n   */\r\n  value?: any\r\n  /**\r\n   * Array of logs logged while running the test\r\n   */\r\n  logs?: Log[]\r\n  /**\r\n   * Time at which the test started(high precision timestamp)\r\n   */\r\n  executionStart?: number\r\n  /**\r\n   * Time at which the test ended(high precision timestamp)\r\n   */\r\n  executionEnd?: number\r\n  /**\r\n   * Code coverage of the test\r\n   * Can be undefined if environment doesn't support native Coverage (in browser)\r\n   * todo: think of using instanbul for in browser coverage when parcel v2 will be released\r\n   */\r\n  coverage?: CoverageEntry\r\n\r\n  //** Properties from the test when analyzed\r\n  /**\r\n   * Percent of code run by the test from the file\r\n   */\r\n  codeCoverage?: number\r\n  /**\r\n   * Time at which the test analyze started(high precision timestamp)\r\n   */\r\n  analyzeStart?: number\r\n  /**\r\n   * Time at which the test analyze ended(high precision timestamp)\r\n   */\r\n  analyzeEnd?: number\r\n}\r\n\r\nexport interface Analyze {\r\n\r\n}\r\n\r\nexport enum MESSAGE {\r\n  GET_TESTS,\r\n  GET_TESTS_RESPONSE,\r\n  \r\n  RUN_TESTS,\r\n  RUN_TESTS_RESPONSE,\r\n\r\n  RUN_TEST,\r\n  RUN_TEST_RESPONSE\r\n}\r\n\r\nconst messageMap = new Map<MESSAGE, MESSAGE>([\r\n  [MESSAGE.GET_TESTS, MESSAGE.GET_TESTS_RESPONSE],\r\n  [MESSAGE.RUN_TESTS, MESSAGE.RUN_TESTS_RESPONSE],\r\n  [MESSAGE.RUN_TEST, MESSAGE.RUN_TEST_RESPONSE]\r\n])\r\n\r\nexport const getMessageResponse = message => messageMap.get(message)\r\n\r\n// https://github.com/parcel-bundler/parcel/issues/2574#issuecomment-459694774\r\nexport enum PARCEL_REPORTER_EVENT {\r\n  BUILD_START = 'buildStart',\r\n  BUILD_PROGRESS = 'buildProgress',\r\n  BUILD_SUCCESS = 'buildSuccess',\r\n  BUILD_FAILURE = 'buildFailure',\r\n  LOG = 'log'\r\n}\r\n\r\nexport enum REPORTER_EVENT {\r\n  BUILD_START = 'buildStart',\r\n  BUILD_PROGRESS = 'buildProgress',\r\n  BUILD_SUCCESS = 'buildSuccess',\r\n  BUILD_FAILURE = 'buildFailure',\r\n  LOG = 'log',\r\n  PORT_SEARCH = 'portSearch',\r\n  PORT_FOUND = 'portFound',\r\n  WEB_SERVER_START = 'webServerStart',\r\n  WEB_SERVER_READY = 'webServerReady',\r\n  STATE = 'state'\r\n}\r\n\r\nexport enum TARGET {\r\n  BROWSER = 'browser',\r\n  NODE = 'node'\r\n}\r\n\r\nexport enum BROWSER {\r\n  FIREFOX = 'firefox',\r\n  FIREFOX_NIGHTLY = 'firefoxNightly',\r\n  CHROME = 'chrome',\r\n  CHROME_CANARY = 'chromeCanary'\r\n}\r\n\r\nexport enum RUNTIME {\r\n  FIREFOX = 'firefox',\r\n  FIREFOX_NIGHTLY = 'firefoxNightly',\r\n  CHROME = 'chrome',\r\n  CHROME_CANARY = 'chromeCanary',\r\n  NODE = 'node'\r\n}\r\n\r\nexport interface RuntimeProvider extends Observable<Runtime> {\r\n  runtimeName: RUNTIME\r\n}\r\n\r\nexport interface Runtime extends Observable<any> {\r\n  loadFile(file: TestFile): Promise<ElementHandle>\r\n  inMessages: Subject<any>\r\n  outMessages: Subject<any>\r\n}\r\n\r\nexport enum LOG {\r\n  log = 'log',\r\n  info = 'info',\r\n  warn = 'warn',\r\n  error = 'error',\r\n  uncaughtError = 'uncaughtError'\r\n}\r\n\r\nexport interface MetaStack {\r\n  file: string\r\n  source: string\r\n  name: string\r\n  line: number\r\n  column: number\r\n  originalSource: string\r\n  originalName: string\r\n  originalLine: number\r\n  originalColumn: number\r\n}\r\n\r\nexport interface Error {\r\n  message: string\r\n  name: string\r\n  stack: string\r\n  string: string\r\n  metaStack?: MetaStack[]\r\n  originalStack?: string\r\n}\r\n\r\nexport interface Log {\r\n  type: LOG\r\n  arguments?: any[]\r\n  error?: Error\r\n}\r\n","import { stringify as _stringify, parse as _parse } from 'flatted'\r\n\r\nimport { EPK_FUNCTION_PROPERTY_PLACEHOLDER } from '../types.ts'\r\n\r\nexport const stringify = data =>\r\n  _stringify(\r\n    data,\r\n    (key, val) =>\r\n      typeof val === 'function'\r\n        ? {\r\n          [EPK_FUNCTION_PROPERTY_PLACEHOLDER]: val.name\r\n        }\r\n        : val)\r\n\r\nexport const parse = data =>\r\n  _parse(\r\n    data,\r\n    (_, val) =>\r\n      val?.[EPK_FUNCTION_PROPERTY_PLACEHOLDER]\r\n        // Way to dynamically set a function name (to render via `util.inspect` from the reporter)\r\n        ? {\r\n          [val[EPK_FUNCTION_PROPERTY_PLACEHOLDER]]: () => {}\r\n        }[val[EPK_FUNCTION_PROPERTY_PLACEHOLDER]]\r\n        : val)","import { Subject } from 'rxjs'\r\nimport { map } from 'rxjs/operators'\r\nimport { parse, stringify } from '../utils/flatted.ts'\r\n\r\nimport { EPK_SUBJECT, EPK_RUNTIME_SUBJECT } from '../types.ts'\r\n\r\nconst subject = globalThis[EPK_SUBJECT] = new Subject()\r\nexport const inMessages =\r\n  // @ts-ignore\r\n  subject\r\n  // @ts-ignore\r\n  |> map(parse)\r\n\r\nconst sendMessage = globalThis[EPK_RUNTIME_SUBJECT]\r\nexport const outMessages = new Subject()\r\n// @ts-ignore\r\noutMessages.subscribe(value =>\r\n  sendMessage(stringify(value)))","import { isObservable } from 'rxjs'\r\nimport { toArray, filter } from 'rxjs/operators'\r\n\r\nimport { MESSAGE } from '../types.ts'\r\n\r\nimport { inMessages, outMessages } from './utils.ts'\r\n\r\nexport const tests = new Map<string, Function>()\r\n\r\nexport const todo = _ => {}\r\nexport const pass = _ => {}\r\nexport const fail = _ => {}\r\n\r\nexport const test = (desc, func) => {\r\n  if (typeof desc !== 'string') throw new TypeError('desc has to be a string')\r\n  if (typeof func !== 'function') throw new TypeError('func has to be a function')\r\n  if (tests.has(desc)) throw new Error(`Found duplicate test description: ${desc}`)\r\n  tests.set(desc, func)\r\n}\r\n\r\nconst getTests = () =>\r\n  outMessages.next({\r\n    type: MESSAGE.GET_TESTS_RESPONSE,\r\n    tests:\r\n      Array\r\n        .from(tests)\r\n        .map(([description, func]) => ({\r\n          description,\r\n          body: func.toString()\r\n        }))\r\n  })\r\n\r\nconst runTest = async ({ description }) => {\r\n  // Empty the logs\r\n  // logs.splice(0, logs.length)\r\n\r\n  // todo: replace by \"isBrowser ? window : require('perf_hooks')\"\r\n  const { performance } = window\r\n  let executionStart, executionEnd, value\r\n\r\n  try {\r\n    executionStart = performance.now()\r\n    value = await tests.get(description)()\r\n    if (isObservable(value)) {\r\n      // @ts-ignore\r\n      value = await (value |> toArray()).toPromise()\r\n    }\r\n  } finally {\r\n    executionEnd = performance.now()\r\n\r\n    setTimeout(() =>\r\n      outMessages.next({\r\n        type: MESSAGE.RUN_TEST_RESPONSE,\r\n        test: {\r\n          executionStart,\r\n          executionEnd,\r\n          type:\r\n            isObservable(value) ? 'observable'\r\n              : value instanceof Promise ? 'promise'\r\n              : 'function',\r\n          value\r\n        }\r\n      }), 0)\r\n  }\r\n}\r\n\r\nconst messagesMap = new Map<MESSAGE, (...args) => any>([\r\n  [MESSAGE.GET_TESTS, getTests],\r\n  [MESSAGE.RUN_TEST, runTest]\r\n])\r\n\r\nconst messages =\r\n  inMessages\r\n  // @ts-ignore\r\n  |> filter(({ type }) => type in MESSAGE)\r\n\r\n// @ts-ignore\r\nmessages.subscribe(({ type, ...rest }) =>\r\n  messagesMap.get(type)({ type, ...rest }))\r\n"],"names":["PowerAssert","customize","EPK_SUBJECT","EPK_RUNTIME_SUBJECT","EPK_FUNCTION_PROPERTY_PLACEHOLDER","MESSAGE","messageMap","Map","GET_TESTS","GET_TESTS_RESPONSE","RUN_TESTS","RUN_TESTS_RESPONSE","RUN_TEST","RUN_TEST_RESPONSE","PARCEL_REPORTER_EVENT","REPORTER_EVENT","TARGET","BROWSER","RUNTIME","LOG","stringify","data","_stringify","key","val","name","parse","_parse","_","subject","globalThis","Subject","inMessages","map","sendMessage","outMessages","subscribe","value","tests","todo","pass","fail","test","desc","func","TypeError","has","Error","set","getTests","next","type","Array","from","description","body","toString","runTest","performance","window","executionStart","executionEnd","now","get","isObservable","toArray","toPromise","setTimeout","Promise","messagesMap","messages","filter","rest"],"mappings":"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"}